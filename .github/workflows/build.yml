name: Build (Nuitka + UPX)

on:
  workflow_dispatch:
    inputs:
      release:
        description: 'Create GitHub Release?'
        required: true
        default: 'false'
  push:
    tags: ["v*"]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check files
        run: dir assets

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Read APP_VERSION from main.py
        id: get_version
        run: |
          $version = Select-String -Path main.py -Pattern '^APP_VERSION\s*=\s*"(.*)"' | ForEach-Object { $_.Matches[0].Groups[1].Value }
          echo "version=$version" >> $env:GITHUB_ENV

      - name: Set YEAR env
        run: echo "YEAR=$(Get-Date -Format yyyy)" >> $env:GITHUB_ENV
        shell: pwsh

      - name: Debug Version and YEAR
        run: echo "Version is $env:version" && echo "YEAR is $env:YEAR"
        shell: pwsh

      - name: Install Nuitka and deps
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          pip install -U nuitka zstandard ordered-set
          if (Test-Path "requirements.txt") { pip install -r requirements.txt }
          python -V
          python -m nuitka --version

      - name: Download UPX
        shell: powershell
        run: |
          $UPX_VERSION = "5.0.2"
          $zip = "$env:RUNNER_TEMP\upx.zip"
          $dst = "C:\UPX"
          Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v$UPX_VERSION/upx-$UPX_VERSION-win64.zip" -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath "$env:RUNNER_TEMP\upx" -Force
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Copy-Item "$env:RUNNER_TEMP\upx\upx-$UPX_VERSION-win64\upx.exe" $dst -Force
          echo "UPX_BIN=$dst" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Build with Nuitka + UPX
        shell: bash
        run: |
          python -m nuitka \
            --jobs=4 \
            --enable-plugin=upx \
            --upx-binary="$UPX_BIN" \
            --enable-plugin=multiprocessing \
            --lto=yes \
            --enable-plugin=tk-inter \
            --windows-console-mode=disable \
            --follow-imports \
            --windows-icon-from-ico="assets/icon.png" \
            --include-data-dir=assets=assets \
            --python-flag=no_site,no_asserts,no_docstrings,static_hashes \
            --onefile \
            --onefile-no-compression \
            --standalone \
            --msvc=latest \
            --assume-yes-for-downloads \
            --output-filename=Wordle-Solver \
            --company-name="Titan Computer" \
            --product-name="Wordle Solver" \
            --file-version=${{ env.version }} \
            --product-version=${{ env.version }} \
            --file-description="Wordle Solver is a Python GUI app to solve Wordle puzzles using smart algorithms." \
            --copyright="Copyright (c) ${{ env.YEAR }} Titan Computer. All rights reserved." \
            --trademarks="Wordle Solver is a trademark of Titan Computer." \
            main.py
          
      # -------------------------
      # ðŸ”’ SELF SIGN CERT HERE
      # -------------------------
      - name: Self-sign the executable
        shell: powershell
        run: |
          Write-Host "Creating self-signed certificate..."

          # Create self-signed certificate
          $cert = New-SelfSignedCertificate `
            -DnsName "Titan Computer" `
            -Type CodeSigningCert `
            -CertStoreLocation "Cert:\CurrentUser\My" `
            -KeyExportPolicy Exportable `
            -NotAfter (Get-Date).AddYears(5)

          # Export certificate to PFX
          $pwd = ConvertTo-SecureString -String "P@ssw0rd123!" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "signcert.pfx" -Password $pwd | Out-Null

          # Find signtool.exe (x64 only)
          Write-Host "Searching for signtool.exe (x64 only)..."
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Filter signtool.exe -Recurse -ErrorAction SilentlyContinue |
                      Where-Object { $_.FullName -match '\\x64\\' } |
                      Select-Object -First 1

          if ($null -eq $signtool) {
              Write-Error "x64 signtool.exe not found!"
          } else {
              Write-Host "Using signtool at: $($signtool.FullName)"
          }

          Write-Host "Using signtool at: $($signtool.FullName)"

          # Sign the executable
          & "$($signtool.FullName)" sign /f "signcert.pfx" /p "P@ssw0rd123!" `
            /tr "http://timestamp.digicert.com" /td sha256 /fd sha256 "Wordle-Solver.exe"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Wordle-Solver
          path: Wordle-Solver.exe

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        if: github.event.inputs.release == 'true' || startsWith(github.ref, 'refs/tags/')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.version }}
          name: v${{ env.version }}
          draft: false
          prerelease: false
          files: Wordle-Solver.exe
